<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="UTF-8">

  <!-- Enable responsiveness on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      ThothBackup - Part 2 &middot; Bit of A Byte
    
  </title>

  
  <!-- canonical link -->
  <link rel="canonical" href="/2018/12/02/ThothBackup-Part-2/">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Dosis">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">

  <!-- Icons -->
  <!-- <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> -->
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Google Analytics -->
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-130197091-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>My name is Natalie and I spend most of my time taking apart things I have no business taking apart.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/projects/">Projects</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/site/">Site Information</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/tags/">Tags</a>
        
      
    

    <a class="sidebar-nav-item" href="https://github.com/zyradyl/zyradyl.github.io">Currently v0.6.0</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://creativecommons.org/publicdomain/zero/1.0/">
        Ø 2018 - No Rights Reserved.
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            
                 <small><a href="http://127.0.0.1">$USER</a>@<a href="/" title="Home">bit-of-a-byte</a>
              ~ $ cat /var/log/thothbackup-part-2.log</small>
              
            </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">ThothBackup - Part 2</h1>
  <span class="post-date">02 Dec 2018</span>
  <p>Hello! It’s that time of the week again, where I update everyone on my latest
work. This episode is far less technical and focuses more on the concept of a
“One and Done” backup solution, aka the holy grail of data maintenance.</p>

<p>It fucking sucks.</p>

<h3 id="introduction">Introduction</h3>
<p>This entry is slightly unidirectional. The concept of a simple, easy to
implement, catch everything you might ever need solution is quite literally the
holy grail, yet it has never honestly been implemented. Sure, user data is
generally scooped out, but in the day and age of game mods, and with some
development projects taking place outside of the User directory, it seemed
prudent to at least <em>attempt</em> the full backup. Well, I’ve been attempting it
for seven days. Here’s what I’ve found.</p>

<h3 id="focus">Focus</h3>
<p>We will not be focusing on the space impact of a complete backup. This is
actually fairly negligible. With out-of-band deduplication, only one set of
operating system files would ever be stored, so server side storage would reach
a weird type of equilibrium fairly quickly. Instead, I’ll talk about three
things:</p>

<ul>
  <li>Metadata Overhead</li>
  <li>Metadata Processing</li>
  <li>Initial Synchronization</li>
</ul>

<p>There may be another post tonight talking about additional things, but this
deserves it’s own little deal.</p>

<h3 id="metadata-overhead">Metadata Overhead</h3>
<p>A fully updated Windows 10 partition of your average gamer, aka my fiancé, is
composed of <strong>479,641 files</strong> and <strong>70,005 directories</strong> which comprise a total
data size of <strong>~216 GiB</strong>. This is actually just the C drive and typical
programs. If you factor in the actual game drive in use by our test case, that
drive contains <strong>354,315 files</strong> and <strong>29,111 directories</strong> which comprise a
total of <strong>~385 GiB</strong> of space.</p>

<p>In summation, an initial synchronization of what is typically considered a “full
system backup” comprises <strong>833,956 files</strong> and <strong>99116 directories</strong> comprising
<strong>~601GiB</strong> which results in an average filesize of <strong>~755KiB</strong> and an average
directory size of <strong>~9 files</strong>.</p>

<p>SyncThing creates a block store that is comprised of, by default, <strong>128KiB</strong>
blocks. This means that for our system, assuming the data is contiguous, we need
<strong>4923392 Metadata Entries</strong>. Assuming the files are NOT contiguous, this is
probably closer to about <strong>5 Million</strong> metadata entries. As of right now, the
server side metadata storage for the testing pool is at <strong>1.7 GiB</strong> and initial
syncronization is <strong>not yet complete</strong>. Extrapolating a bit, we can assume that
<strong>2.0 GiB</strong> would not be an unreasonable size for a final server side data
store.</p>

<p>The client side store, at the time of writing, is approximately <strong>1 GiB</strong> and
may grow slightly larger. However, I will use <strong>1 GiB</strong>. This means that there
is a plausible total of <strong>3GiB of metadata overhead</strong> representing an overhead
percentage of <strong>~0.5%</strong> across the pool. Scaling up, this means 10 clients
with 1TB of data each would require <strong>51.2GB of Metadata</strong>.</p>

<p><strong>Should anything happen to the metadata store, it would need to be rebuilt by
data reprocessing. This introduces a potentially massive liability, as scanning
frequency would need to be reduced to not impact the rebuild operation.</strong></p>

<h3 id="metadata-processing">Metadata Processing</h3>
<p>The server is capable of a hash rate of <strong>107MB/s</strong>. I am picking the server’s
hash rate because it is both the slowest hash rate of the pool and would have
the most metadata that would need to be rebuilt.</p>

<p>For a complete rebuild of the data of our current cluster, it would take the
server <strong>~96 Minutes</strong> during which no data synchronization could occur. This
equates to a minimum of <strong>1 Missed Hourly Update</strong> and could potentially result
in up to 2 missed hourly updates if the timing was unfortunate enough.</p>

<p>For a complete rebuild of the data of our theoretical cluster, we will allow for
a hash rate of <strong>300MB/s</strong>. The total data needed to be rebuilt would be 10TB.
This would result in a database rebuilt time of <strong>~10 Hours</strong> which could result
in up to 11 missed synchronization attempts.</p>

<h3 id="initial-synchronization">Initial Synchronization</h3>
<p>The initial syncronization is composed of three primary parts. First, the
client and host must agree on what folders to syncronize. Second, the client
must build a database of the content hosted locally. Next, utilizing a rolling
hash algorithm, data is entered into the metadata cache and transmitted to the
server.</p>

<p><em>Per the developer of SyncThing, millions of small files are the worst case
scenario for the backup system.</em> As of my independent, albeit anecdotal testing,
After 7 days the synchronization process is still in effect. This represents a
very <strong>poor user experience</strong> and would not be ideal for a widespread rollout.</p>

<h3 id="conclusion">Conclusion</h3>
<p>The primary goal of a backup utility is to synchronize files and achieve cross
system consistency as quickly as possible. While it is true that eventually
consistent systems are utilized in large scale operations, this type of
consistency is allowable only, in my opinion, at data sizes over 10TB. The
current testing set is approximately 1TB at most, and thus this is unacceptable.</p>

<p><strong>Either the backup paradigm must change, or the utility used to implement it
must change.</strong> While I do not expect to find any faster utilities for performing
the backup process, I do plan to continue to experiment. At this time, however,
it seems that the most likely way to make the process as friendly as possible
would be the implementation of a default backup subset, with additional data
added upon user request, and after the high priority synchronization had been
completed.</p>

</div>

<div class="related">
<h2>Related Posts</h2>



  
    
    
    
    <ul class="related-posts">
    
  
    
    
    
    <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/2018/12/09/ThothBackup-Part-3/">
          ThothBackup - Part 3 <!--<span class="label label-default">BorgBackup</span>-->  <!--<span class="label label-default">Git</span>-->  <!--<span class="label label-default">Git-Annex</span>-->  <!--<span class="label label-default">Wasabi</span>-->  <!--<span class="label label-default">SyncThing</span>--> 
          <small>
            09 Dec 2018
          </small>
        </a>
      </h3>
    </li>
      
      
    
  
    
    
    
    <ul class="related-posts">
    
  
    
    
    
    <ul class="related-posts">
    
  
    
    
    
    <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/2018/11/28/ThothBackup-Part-1/">
          ThothBackup - Part 1 <!--<span class="label label-default">BorgBackup</span>-->  <!--<span class="label label-default">Git</span>-->  <!--<span class="label label-default">Git-Annex</span>-->  <!--<span class="label label-default">Wasabi</span>-->  <!--<span class="label label-default">SyncThing</span>--> 
          <small>
            28 Nov 2018
          </small>
        </a>
      </h3>
    </li>
      
      
    
  
    
    
    
    <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/2018/11/10/Yet-Another-Backup-System-Part-1/">
          Yet Another Backup System - Part 1 <!--<span class="label label-default">BorgBackup</span>-->  <!--<span class="label label-default">Git</span>-->  <!--<span class="label label-default">Git-Annex</span>-->  <!--<span class="label label-default">Wasabi</span>-->  <!--<span class="label label-default">SyncThing</span>--> 
          <small>
            10 Nov 2018
          </small>
        </a>
      </h3>
    </li>
      
      
        
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
