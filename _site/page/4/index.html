<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="UTF-8">

  <!-- Enable responsiveness on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Home - page 4 &middot; Bit of A Byte
    
  </title>

  
  <!-- canonical link -->
  <link rel="canonical" href="/page/4/index.html">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Dosis">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">

  <!-- Icons -->
  <!-- <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png"> -->
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Google Analytics -->
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-130197091-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>My name is Natalie and I spend most of my time taking apart things I have no business taking apart.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/archive/">Archive</a>
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/projects/">Projects</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/site/">Site Information</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/tags/">Tags</a>
        
      
    

    <a class="sidebar-nav-item" href="https://github.com/zyradyl/zyradyl.github.io">Currently v0.6.0</a>
  </nav>

  <div class="sidebar-item">
    <p>
      <a href="https://creativecommons.org/publicdomain/zero/1.0/">
        Ø 2018 - No Rights Reserved.
      </a>
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            
                
            <small><a href="http://127.0.0.1">$USER</a>@<a href="/" title="Home">bit-of-a-byte</a>
         ~ $ cat $(find /var/log -name '*.log' -print | awk 'NR>15&amp;&amp;NR&lt;=20')</small>
            
            </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/17/Icinga2-Tutorial-Part-3/">
        Icinga2 Tutorial: Part 3 - Agent-Based Checks
      </a>
    </h1>

    <span class="post-date">17 Aug 2015</span>

    <ul>
  <li><a href="/2015/08/10/Icinga2-Tutorial-Part-0/" title="Icinga2 Tutorial Part 0">Icinga2 Tutorial: Part 0 - Network Monitoring for the Masses</a></li>
  <li><a href="/2015/08/11/Icinga2-Tutorial-Part-1/" title="Icinga2 Tutorial Part 1">Icinga2 Tutorial: Part 1 - Installation and Configuration</a></li>
  <li><a href="/2015/08/12/Icinga2-Tutorial-Part-2/" title="Icinga2 Tutorial Part 2">Icinga2 Tutorial: Part 2 - Agent-Less Checks</a></li>
  <li><a href="/2015/09/07/Icinga2-Tutorial-Part-4/" title="Icinga2 Tutorial Part 4">Icinga2 Tutorial: Part 4 - Extending Checks to SNMP</a></li>
</ul>

<p><strong>EDIT (2018/12/09):</strong> <em>These guides haven’t been updated since 2015. It is
possible that there are dead links, or that the configuration syntax has changed
dramatically. These posts are also some of the most popular on my blog. I plan
to do a new guide eventually, but for right now please take the following
entries with a grain of salt.</em></p>

<p>For this part of the tutorial, we are actually going to be rewriting the host
file for localhost. Unfortunately, I thought the EdgeRouter would be
capable of running an <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc" title="Icinga2 Official Documentation">Icinga2</a> client, but it isn’t available through the
apt repositories, and after the <code class="highlighter-rouge">ntopng</code> incident of July and August, I am
not stressing that processor any more than it needs to be to run my network.
(It is stressed enough as it is, but that is a post for another day.)</p>

<p>Since I have done most of the explaining in the files, these tutorials will
start including the configuration files, and any external resources
I have used.</p>

<h3 id="configuration-file">Configuration File</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * File:        /etc/icinga2/conf.d/captor.conf
 * Title:       Captor Host Configuration File
 * Description: Host and services definition for Icinga2 for
 *              the Captor Localhost.
 * Host:        captor.zyradyl.org
 * System:      Linux Mint Debian Edition 2
 * License:     Creative Commons Zero - Public Domain
 * Version:     1.0
 * Date:        August 16, 2015
 */

//
// Host Declaration Block
//
object Host "captor.zyradyl.org" {
    // Define the host IPv4 Address
    address         = "127.0.0.1"
    // Define the host IPv6 Address
    address6        = "::1"
    // Define the operating system
    vars.os         = "Linux"
    // Define a basic functionality test
    // Hostalive does a basic ICMP ECHO to the target
    // specified in the address directive.
    check_command   = "hostalive"
}

//
// There are two ways that we can configure Icinga2.
// The first method is to write specific files for
// every host, which is a good idea if you only have
// a few hosts, and every host has something
// different going on. The other method wold be to
// use apply service logic, which is better for
// larger deployments. I have provided links to
// both a best practices guide as well as to a guide
// on apply logic. I will be using files on a per
// host basis for my deployment.
//

// For demonstration purposes I am setting up an
// IPv6 Ping check.

//
// Service Declaration Block
// Service:     Ping6
// Description: Check if Host is responding to IPv6
// Note:        The address6 specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "ping6" {
    host_name     = "captor.zyradyl.org"
    check_command = "ping6"
}

//
// Service Declaration Block
// Service:     HTTP.server
// Description: Checks if Apache in general is up.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
// We are specifying an additional part on the service
// because we are also going to check to make sure that
// IcingaWeb2 is running.
//
object Service "http.server" {
    host_name               = "captor.zyradyl.org"
    // This tells Icinga to check only this specific
    // page.
    vars.http_uri           = "/"
    check_command           = "http"
}

//
// Service Declaration Block
// Service:     HTTP.icingaweb2
// Description: Check if the IcingaWeb service is up.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "http.icingaweb" {
    host_name               = "captor.zyradyl.org"
    // This tells Icinga to check only this specific
    // page.
    vars.http_uri           = "/icingaweb2"
    check_command           = "http"
}

//
// Service Declaration Block
// Service:     SSL Cert Check
// Description: Check expiration date of SSL certificates.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
// The following is commented out because captor doesnt offer
// HTTPS.
//
//object Service "ssl" {
//    host_name                         = "wepwawet.zyradyl.org"
//    vars.ssl_port                     = "443"
//    vars.ssl_cert_valid_days_warn     = "30"
//    vars.ssl_cert_valid_days_critical = "15"
//    check_command                     = "ssl"
//}

//
// Service Declaration Block
// Service:     Disks
// Description: Checks status of all installed disks.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "disks" {
    host_name                     = "captor.zyradyl.org"
    // We need to exclude a particular partition due to
    // access denials.
    vars.disk_partitions_excluded = "/run/user/1000/gvfs"
    check_command                 = "disk"
}

//
// Service Declaration Block
// Service:     Icinga
// Description: Checks status of Icinga Instance.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "icinga" {
    host_name     = "captor.zyradyl.org"
    check_command = "icinga"
}

// Service Declaration Block
// Service:     Load
// Description: Checks how much load the host is under.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "load" {
    host_name     = "captor.zyradyl.org"
    check_command = "load"
}

// Service Declaration Block
// Service:     Procs
// Description: Checks number of processes on host.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "procs" {
    host_name     = "captor.zyradyl.org"
    check_command = "procs"
}

//
// Service Declaration Block
// Service:     SSH
// Description: Checks if SSH is available.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
// Note:        Captor does not provide ssh services.
//              Commenting out this service.
//
//object Service "ssh" {
//    host_name     = "captor.zyradyl.org"
//    check_command = "ssh"
//}

// Service Declaration Block
// Service:     Swap
// Description: Checks status of swap space on host.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "swap" {
    host_name     = "captor.zyradyl.org"
    check_command = "swap"
}

// Service Declaration Block
// Service:     Users
// Description: Checks number of users on the system
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "users" {
    host_name     = "captor.zyradyl.org"
    check_command = "users"
}

// Service Declaration Block
// Service:     Apt
// Description: Checks status of the apt package manager.
// Note:        The address specified in the above directive  
//              is carried into the service declaration
//              blocks via specifying the host_name variable
//
object Service "apt" {
    host_name     = "captor.zyradyl.org"
    check_command = "apt"
}

// EOF
</code></pre></div></div>

<h3 id="import-notes">Import Notes</h3>
<p>It is worth noting that this article was intended to be a quick write up to
get something online. In time, I may come back to rewrite things, but at the
very least I hope the comments in the file are helpful.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/16/UBNT-ERL-SquashFS-Read-Error/">
        Ubiquiti EdgeRouter Lite SquashFS Block Read Error: Part 1
      </a>
    </h1>

    <span class="post-date">16 Aug 2015</span>

    <h2 id="problem-description">Problem Description</h2>
<p>Upon booting the EdgeRouter Lite, the system will not boot. Connecting to
console reveals the following log:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQUASHFS error: zlib_inflate error, data probably corrupt
SQUASHFS error: squashfs_read_data failed to read block 0x1b4574
SQUASHFS error: Unable to read fragment cache entry [1b4574]
SQUASHFS error: Unable to read page, block 1b4574, size 8519
SQUASHFS error: Unable to read fragment cache entry [1b4574]
SQUASHFS error: Unable to read page, block 1b4574, size 8519
</code></pre></div></div>

<p>This can be caused by an unclean shutdown, which could potentially occur with a
power failure. Due to the failure, parts of the internal ext3 filesystem
become corrupted, which causes the inability to load the SquashFS partition
which contains EdgeOS. The end result, of course, is a non-functional unit.</p>

<h2 id="problem-severity">Problem Severity</h2>
<p>There are four potential levels to determining the severity of this issue:</p>

<ul>
  <li>Can the filesystem be salvaged by fscking the ext3 partition until it is
salvageable? (<strong>Severity:</strong> Annoying.)</li>
  <li>If the answer to the above is no, can the flash drive be saved by zeroing out
the device and writing a new filesystem to it? (<strong>Severity:</strong> Hardware issue -
End user repair possible..)</li>
  <li>If the answer to the above is no, is the device capable of booting? If yes, it
is possible you may be suffering
from the <a href="https://community.ubnt.com/t5/EdgeMAX/EdgeRouter-LITE-OS-and-hardware-problems/td-p/667557">EdgeRouter Lite RAM issue</a>. (<strong>Severity:</strong> Hardware issue -
RMA the device.)</li>
  <li>If the answer to the above is no, is the device under warranty? If yes,
(<strong>Severity:</strong> Hardware issue - RMA the device.) If no, (<strong>Severity:</strong> Device
Replacement.)</li>
</ul>

<h2 id="problem-resolution">Problem Resolution</h2>
<p>Resolutions will be broken down into two posts, one for each problem the user
could resolve without warranty work.</p>

<h3 id="resolution-credits">Resolution Credits</h3>
<p>A special thanks to Ubiquiti for providing a community support option via
their official website. Additionally, special thanks to all those users that
utilize said forum, your information was invaluable in helping me to fix my
EdgeRouter, and write this article.</p>

<h2 id="resolution-one-repair-the-file-system">Resolution One: Repair the File System</h2>
<p>This is by far the easiest resolution. Open the EdgeRouter Lite (<strong>Caution:</strong>
<em>Your warranty is now void. Depending on how soon you need the device
back in operation, it may be acceptable for you to void the warranty on a
$100USD device if you can get it back in service by the end of the day. If
you think your device may need to be RMA’d, do not open the device and proceed
to UBNT’s Support Site.</em>) by removing two screws on the bottom
of the device, located right under where the interface connections are. Your
device will slide apart, revealing the internal board. On the board you
will see a soldered on female USB port with a small silver USB flash drive,
roughly 3cm long. This is your 2GB of internal memory, but the device itself
is 2.6GB.</p>

<p>Remove the USB drive and plug it into a USB port on your Mac OSX or Linux
powered device. Open a terminal, and run dmesg. You are looking for the
devfs name of your device.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[  262.645401] scsi 2:0:0:0: Direct-Access                               5.00 PQ: 0 ANSI: 2
[  262.647109] sd 2:0:0:0: Attached scsi generic sg1 type 0
[  262.648527] sd 2:0:0:0: [sdb] 4057088 512-byte logical blocks: (2.07 GB/1.93 GiB)
[  262.648795] sd 2:0:0:0: [sdb] Write Protect is off
[  262.648817] sd 2:0:0:0: [sdb] Mode Sense: 0b 00 00 08
[  262.649095] sd 2:0:0:0: [sdb] No Caching mode page found
[  262.649114] sd 2:0:0:0: [sdb] Assuming drive cache: write through
[  262.652309]  sdb: sdb1
[  262.655018] sd 2:0:0:0: [sdb] Attached SCSI removable disk
</code></pre></div></div>

<p>In this case, my device name is <code class="highlighter-rouge">sdb</code>. Please note that for this guide I am not
using an actual EdgeRouter flash drive. This is a stand-in device. The next
thing to do is make sure none of the partitions on the device have been
automatically mounted. Where I used <code class="highlighter-rouge">sdb</code> in the following example, use whatever
dmesg identified as your USB device.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ mount | grep sdb
/dev/sdb1 on /media/zyradyl/b7bcf200-26a1-41ed-9122-625558dbc907 type ext4 (rw,nosuid,nodev,relatime,data=ordered,uhelper=udisks2)
</code></pre></div></div>

<p>This would indicate that at least one of the partitions on the disk has been
mounted. To correct this we need to use the <code class="highlighter-rouge">umount</code> command. Note that in
some operating systems an eject button exists in the taskbar. In my experience,
not only do these buttons unmount the mounted partitions, it also removed the
device entry from the kernel. So I prefer to use manual <code class="highlighter-rouge">umount</code> commands. In
the following example, do one line per mounted partition, substituting the
device names of your partitions where I specified <code class="highlighter-rouge">/dev/sdb1</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ sudo umount /dev/sdb1
</code></pre></div></div>

<p>Once you have unmounted the devices, you can use fdisk to get a good view
of the partition layout on your USB device. I like to do this even if I know
what I should expect, just as a form of a sanity test to make sure I have the
right device. Note that, as previously stated, this device is a stand in. I have
tried to recreate the partition table to the best of my memory.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ sudo fdisk -l /dev/sdb

Disk /dev/sdb: 2 GiB, 2077229056 bytes, 4057088 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xd9dd6356

Device     Boot  Start     End Sectors  Size Id Type
/dev/sdb1         2048  264191  262144  128M  b W95 FAT32
/dev/sdb2       264192 4057087 3792896  1.8G 83 Linux
</code></pre></div></div>

<p>So we can see from the above that we have two partitions on the USB device. In
your case, when using an actual EdgeRouter flash drive, one of the partitions
will be a vfat partition type, and the second one will be a linux
partition type. Now that we know where our partitions are, and that they are
safely unmounted, we can use fsck. Remember to replace my instance of <code class="highlighter-rouge">sdb2</code>
with the correct partition for your device. Note that depending on the damage to
the filesystem, this has the potential to be a <strong>destructive operation</strong>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ fsck.ext3 -fvy /dev/sdb2
</code></pre></div></div>

<p>Allow the program to run till completion. If you notice the command has become
looped, you will need to clear the journal out on your device. Note that
this is a <strong>potentially destructive operation</strong> to data that had not been
written from the journal to the disk. The first thing that we need to do is
clear out the recovery indicator using <code class="highlighter-rouge">debugfs</code> Remember to replace <code class="highlighter-rouge">sdb2</code>
with the proper device name of your ext3 partition.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ debugfs -w -R “feature ^needs_recovery” /dev/sdb2
</code></pre></div></div>

<p>After clearing out this flag, it is now possible to use <code class="highlighter-rouge">tune2fs</code> to force
removal of the journal.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ tune2fs -f -O ^has_journal /dev/sdb2
</code></pre></div></div>

<p>Now you can go back up and run the <code class="highlighter-rouge">fsck</code> command. Once that is done, you will
need to re-enable the journal on your filesystem.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ tune2fs -f -O has_journal -j size=128M /dev/sdb2
</code></pre></div></div>

<p>Once you have a clean fsck output, and you have your journal enabled again, plug
the USB device back into the EdgeRouter and boot. If you are lucky, everything
will come back as it should. As there may be data loss, make sure to restore
from a recent configuration backup (you <strong>do</strong> have configuration backups,
right?) and reboot, before logging into the device through ssh to make sure
everything is where it should be.</p>

<p>If you are still having problems, stick around for part two of this guide, where
I will be walking you through using a separate host computer to recreate the
filesystem.</p>

<p><strong>EDIT (2018/12/09):</strong> <em>Part 2 was never written, but this is actually a fairly
common issue with EdgeRouter Lites. A simple Google search should turn up the
EdgeRouter Emergency Recovery Kit GitHub, and that plus some posts on the UBNT
forums should help you solve the problem. Sorry about my inability to deliver
on what I mention in my posts.</em></p>

<h2 id="external-links--resources">External Links &amp; Resources</h2>
<p>[How to Recover an EXT3 Volume with an Unreadable Journal][2]</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/12/Icinga2-Tutorial-Part-2/">
        Icinga2 Tutorial: Part 2 - Agent-Less Checks
      </a>
    </h1>

    <span class="post-date">12 Aug 2015</span>

    <ul>
  <li><a href="/2015/08/10/Icinga2-Tutorial-Part-0/">Icinga2 Tutorial: Part 0 - Network Monitoring for the Masses</a></li>
  <li><a href="/2015/08/11/Icinga2-Tutorial-Part-1/">Icinga2 Tutorial: Part 1 - Installation and Configuration</a></li>
  <li><a href="/2015/08/17/Icinga2-Tutorial-Part-3/">Icinga2 Tutorial: Part 3 - Agent-Based Checks</a></li>
  <li><a href="/2015/09/07/Icinga2-Tutorial-Part-4/">Icinga2 Tutorial: Part 4 - Extending Checks to SNMP</a></li>
</ul>

<p><strong>EDIT (2018/12/09):</strong> <em>These guides haven’t been updated since 2015. It is
possible that there are dead links, or that the configuration syntax has changed
dramatically. These posts are also some of the most popular on my blog. I plan
to do a new guide eventually, but for right now please take the following
entries with a grain of salt.</em></p>

<h2 id="master-host-configuration">Master Host Configuration</h2>
<p>So in our last part we focused on getting your machine set up as the
<a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/distributed-monitoring#distributed-monitoring-setup-master">Icinga2 master controller</a>. Now we can focus on getting interoperability
setup. As always, this tutorial assumes you are sudo’d as root. You can do this
by running “sudo -s”. Then we need to set ourselves up as the master node on our
network.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # icinga2 node wizard
Welcome to the Icinga 2 Setup Wizard!

We'll guide you through all required configuration details.

Please specify if this is a satellite setup ('n' installs a master setup) [Y/n]: n
Starting the Master setup routine…
Please specifiy the common name (CN) [captor.zyradyl.org]:
information/cli: Generating new CSR in '/etc/icinga2/pki/captor.zyradyl.org.csr'.
information/cli: Created backup file '/etc/icinga2/pki/captor.zyradyl.org.key.orig'.
information/cli: Created backup file '/etc/icinga2/pki/captor.zyradyl.org.csr.orig'.
information/base: Writing private key to '/etc/icinga2/pki/captor.zyradyl.org.key'.
information/base: Writing certificate signing request to '/etc/icinga2/pki/captor.zyradyl.org.csr'.
information/cli: Signing CSR with CA and writing certificate to '/etc/icinga2/pki/captor.zyradyl.org.crt'.
information/cli: Created backup file '/etc/icinga2/pki/captor.zyradyl.org.crt.orig'.
information/cli: Copying CA certificate to '/etc/icinga2/pki/ca.crt'.
information/cli: Created backup file '/etc/icinga2/pki/ca.crt.orig'.
information/cli: Dumping config items to file '/etc/icinga2/zones.conf'.
Please specify the API bind host/port (optional):
Bind Host []:
Bind Port []:
information/cli: Enabling the APIlistener feature.
information/cli: Updating constants.conf.
information/cli: Updating constants file '/etc/icinga2/constants.conf'.
information/cli: Updating constants file '/etc/icinga2/constants.conf'.
Done.
Now restart your Icinga 2 daemon to finish the installation!

captor zyradyl # service icinga2 restart
checking Icinga2 configuration.
[...]
captor zyradyl #
</code></pre></div></div>

<p>Note that in your case, you may see one or two warning messages, but if it
pertains to files already existing, don’t worry about it, I also clipped all
the output that <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc">Icinga2</a> spits out when it restarts in order to save space.
These posts are long enough as it is. After restarting, if you check the
website for your master node, you will see a whole bunch of new information.
This has also established the certificates the <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/distributed-monitoring#distributed-monitoring-setup-satellite-client">icinga2 protocol</a> uses for
security.</p>

<h2 id="host-monitoring">Host Monitoring</h2>
<p>Now, while it is nice to have access to the Icinga protocol, in our case we
will be working with devices that do not make the option of installing Icinga
possible. Instead, we will be monitoring through four different
protocols: SSH, SNMP(v1), HTTP/S, and ICMP.</p>

<p>We are going to go simple in this route through the use of
<a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/monitoring-basics#check-commands">agent-less checks.</a> Agent-less checks do not rely on having a remote
program installed, and this is useful for embedded devices that may not
have enough memory to host another program.  This is also helpful if your
client only offers one or two services and it isn’t worth taking the time to
install and configure a node setup. For example, you can check if SSH is
available on a remote host, or check if the HTTP server is alive, or even
simply see if the host is alive. We will start there.</p>

<p>Before we get into editing the actual files, Syntax highlighting can make life
a whole lot easier. Note, you should repeat this process with a non-privileged
user as that will give you a way to take a look at icinga2 configuration files
without having to be the root user.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor conf.d # mkdir -p ~/.vim/{syntax,ftdetect}
captor conf.d # cd /usr/share/icinga2-common/syntax/
captor syntax # cp vim/syntax/icinga2.vim ~/.vim/syntax/
captor syntax # cp vim/ftdetect/icinga2.vim ~/.vim/ftdetect/
</code></pre></div></div>

<p>Now test it by opening any file under the <code class="highlighter-rouge">/etc/icinga2/conf.d/</code> directory. You
can find instructions to do this for nano <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/getting-started#configuration-syntax-highlighting-nano">here</a>. Now, there are a lot of
ways to configure Icinga2. You can choose to use the pre-existing
<a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/configuring-icinga2-first-steps#hosts-conf">hosts.conf</a> and <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/configuring-icinga2-first-steps#services-conf">services.conf</a>, or, since the <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/configuring-icinga2-first-steps#conf-d">conf.d</a> directory
is read on startup, you can use one file per host. I will be doing the latter,
as I think it keeps it a lot neater. The Access point is named Wepwawet, so
let’s get started. (Note that you clearly do not need to use my header method.
You can also indent with tabs, I mean.. if you like that kind of uncertainty in
how the file will be displayed.)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor conf.d # vim /etc/icinga2/conf.d/wepwawet.conf
</code></pre></div></div>

<p>You can find the document, with syntax highlighting, <a href="http://pastebin.com/twTv3bem">here</a>.</p>

<p>So with this basic configuration, we get three checks:</p>

<ul>
  <li>An ICMP Echo (hostalive)</li>
  <li>A HTTPS Up Check (http)</li>
  <li>A SSH Up check (ssh)</li>
</ul>

<p>For my HTTP check, the website uses HTTPS, and no HTTP site is available. So
by setting the SSL variable, we can ensure that just HTTPS is being checked.
This ensures we are getting an accurate reading. Now we need to ensure that our
declaration works.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor conf.d # /etc/init.d/icinga2 checkconfig
checking Icinga2 configuration.
captor conf.d # /etc/init.d/icinga2 reload
checking Icinga2 configuration.
Reloading icinga2 monitoring daemon: icinga2.
captor conf.d #
</code></pre></div></div>

<p>Then log in to your web page, and you should see your new host and service
definition. If this works, then move on to the next section. If not, you
should consult the error messages printed out as well as the Icinga2 log that
can be found in <code class="highlighter-rouge">/var/log</code>. A useful method to check if the error is in
your configuration is to run the checks manually. Attempt to ping the
host, or ssh to the host, or access a web page. If you are unable to do
these things manually, the problem may very well be with your host.</p>

<p>The one final thing I would like to do is to demonstrate that you can actually
do a fairly nice amount of checks without needing to have a remote agent.
For this next example, we are going to setup a check that will verify if our
SSL certificate is still valid, or how long we have till it runs out.
Previously, this was done through an <a href="http://namsep.blogspot.com/2014/07/icinga-2-https-and-ssl-key-expiry-check.html">external custom command</a> but Icinga2
now has a <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/plugin-check-commands#plugin-check-command-tcp">TCP check plugin</a> that can do this natively.</p>

<p>Open your configuration file and make the edits. You can follow this file with
syntax colouring <a href="http://pastebin.com/H7TMnCpQ">as an example</a>.</p>

<p>Once done, reload your configuration as demonstrated above. It is worth stating
that the reload parameter also calls checkconfig, however I prefer to run them
as two separate commands. It is also worth stating that you could combine the
SSL certificate check with the HTTPS check. I separate them because for me a
certificate expiring isn’t too big of a deal – it will only throw an error –
but the HTTPS server going down is a much bigger deal.</p>

<p>You can see the
<a href="http://pastebin.com/NnJCYuLM">configuration of the monitoring setup for my core router here</a>.</p>

<h2 id="external-resources">External Resources:</h2>
<ul>
  <li><a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/monitoring-remote-systems#agent-less-checks">Icinga2 Monitoring Remote Systems: Agentless Checks</a></li>
  <li><a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/monitoring-basics#hosts-services">Icinga2 Monitoring Basics: Hosts and Services</a></li>
  <li><a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/plugin-check-commands#plugin-check-command-ssh">Icinga2 Plugin Check Commands: SSH</a></li>
  <li><a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/plugin-check-commands#plugin-check-command-ssl">Icinga2 Plugin Check Commands: SSL</a></li>
  <li><a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/monitoring-basics#command-passing-parameters">Icinga2 Monitoring Basics: Command Passing Variables</a></li>
  <li><a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc#!/icinga2/latest/doc/module/icinga2/chapter/cli-commands#config-validation">Icinga2 Configuration Validation</a></li>
</ul>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/11/Icinga2-Tutorial-Part-1/">
        Icinga2 Tutorial: Part 1 - Installation and Configuration
      </a>
    </h1>

    <span class="post-date">11 Aug 2015</span>

    <ul>
  <li><a href="/2015/08/10/Icinga2-Tutorial-Part-0/">Icinga2 Tutorial: Part 0 - Network Monitoring for the Masses</a></li>
  <li><a href="/2015/08/12/Icinga2-Tutorial-Part-2/">Icinga2 Tutorial: Part 2 - Agent-less Checks</a></li>
  <li><a href="/2015/08/17/Icinga2-Tutorial-Part-3/">Icinga2 Tutorial: Part 3 - Agent-Based Checks</a></li>
  <li><a href="/2015/09/07/Icinga2-Tutorial-Part-4/">Icinga2 Tutorial: Part 4 - Extending Checks to SNMP</a></li>
</ul>

<p><strong>EDIT (2018/12/09):</strong> <em>These guides haven’t been updated since 2015. It is
possible that there are dead links, or that the configuration syntax has changed
dramatically. These posts are also some of the most popular on my blog. I plan
to do a new guide eventually, but for right now please take the following
entries with a grain of salt.</em></p>

<h2 id="introduction">Introduction</h2>
<p>I wanted to get this out fairly quickly, because I just actually did this, and
while the default <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/getting-started#setting-up-icinga2">Icinga2 tutorial</a> is pretty good, it is lacking in some
areas, and since everything is fresh in my mind I wanted to go ahead and draft
this up.</p>

<p>It is worth noting that in this post I will assume you are root. You can get to
root as a sustained environment by using <code class="highlighter-rouge">sudo -s</code>.</p>

<p>I do not condone this for day to day usage, it is <strong>bloody dangerous</strong>.</p>

<p>So, let’s get started. Sudo to root.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zyradyl@captor ~ $ sudo -s
[sudo] password for zyradyl:
captor zyradyl #
</code></pre></div></div>

<h3 id="installing-icinga2">Installing Icinga2</h3>
<p>This assumes you are root, and on a Debian based system. For other
systems, you can find <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/getting-started#setting-up-icinga2">additional documentation here</a>. Note that I follow
that documentation very closely except for a few small notes, so it should be
easy to adjust this tutorial for your needs.</p>

<h4 id="adding-repositories">Adding Repositories</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # wget -O - http://debmon.org/debmon/repo.key 2&gt;/dev/null | apt-key add -
captor zyradyl # echo deb http://debmon.org/debmon debmon-jessie main &gt;/etc/apt/sources.list.d/debmon.list
captor zyradyl # apt-get update
</code></pre></div></div>

<p>The first command downloads the cryptographic key for the debmon
repository and hands it over to apt. Apt then installs that key, which allows
you to verify that you are using packages signed off by and validated by that
repository. The second command is then echoing the debmon main repository into
your apt-sources, so that the software available there is added to your
system’s list, which allows you to install with just a command. The third
command tells your system to update its internal package list to incorporate
the changes. After that we can go ahead and install.</p>

<h4 id="installation">Installation</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # apt-get install icinga2 monitoring-plugins
</code></pre></div></div>

<p>This will install both <a href="https://www.icinga.org/icinga/icinga-2/">icinga2</a> and the nagios monitoring plugins that are
compatible. This gives you a very good base. Start the program through the
service command, and then set it to start on boot with <code class="highlighter-rouge">update-rc.d</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # service icinga2 start
captor zyradyl # update-rc.d icinga2 enable
</code></pre></div></div>

<p>Tada! You now have a data aggregator/network monitor setup! However, we
want a nice way to get information from our monitoring host, so now we need to
install the web front end.</p>

<h2 id="installing-icingaweb2">Installing IcingaWeb2</h2>
<p>Let’s start with all the essentials.</p>

<h3 id="package-installation">Package Installation</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # apt-get install postgresql icinga2-ido-pgsql apache2 php5-ldap php5-imagick php5-pgsql php5-intl icingaweb2 icingaweb2-module-doc icingaweb2-module-monitoring icingaweb2-module-setup
</code></pre></div></div>

<p>This is a big one, so if you are living on about a meg down, prepare to settle
in for a bit. In order, this will install the PostgreSQL database, the
<a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/advanced-topics#db-ido">Icinga2 database connector</a>, the apache2 web server, the ldap php5 module,
the imagemagick module for php5, the postgresql php5 module, the intl php5
module, the IcingaWeb2 core, the IcingaWeb2 documentation module, the IcingaWeb2
monitoring module, and the IcingaWeb2 setup module. Note that on debian systems,
it will prompt you to allow it to setup the database. I <strong>strongly</strong> recommend
you say NO to that, and do it manually.</p>

<p>Once this completes, get everything running and added to the default runlevel.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # service postgresql start
captor zyradyl # update-rc.d postgresql enable
captor zyradyl # service apache2 start
captor zyradyl # update-rc.d apache2 enable
</code></pre></div></div>

<h3 id="database-configuration">Database Configuration</h3>
<p>Now we need to make that database. The first command defines a new user named
“<em>icinga</em>” with a password of the same name. The second command then creates a
database named <strong>icinga</strong>, and grants ownership to the user <strong>icinga</strong>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor zyradyl # cd /tmp
captor tmp # sudo -u postgres psql -c "CREATE ROLE icinga WITH LOGIN PASSWORD 'icinga';"
captor tmp # sudo -u postgres createdb -O icinga -E UTF8 icinga
</code></pre></div></div>

<p>Once this is done, edit the file <code class="highlighter-rouge">pg_hba.conf</code>. This file controls the way
that hosts can authenticate with your database. We want to make sure that
icinga can utilize standard password login, or md5.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # vim /etc/postgresql/9.4/main/pg_hba.conf

    # icinga
    local    icinga    icinga                    md5
    host     icinga    icinga    127.0.0.1/32    md5
    host     icinga    icinga    ::1/128         md5
</code></pre></div></div>

<p>Save, and then restart the database to activate the changes. Once restarted,
we can import the <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/getting-started#configuring-db-ido-postgresql">IDO SQL</a> schema into Postgres. The export line pushes
the password into the environment, thus allowing us to avoid having to type it
in.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # service postgresql restart
captor tmp # export PGPASSWORD=icinga
captor tmp # psql -U icinga -d icinga &lt; /usr/share/icinga2-ido-pgsql/schema/pgsql.sql
</code></pre></div></div>

<p>Now we need to go ahead and enable the features that icinga2 will use.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # icinga2 feature enable command
captor tmp # icinga2 feature enable ido-pgsql
captor tmp # icinga2 feature enable livestatus
captor tmp # icinga2 feature enable statusdata
captor tmp # service icinga2 restart
</code></pre></div></div>

<p>The final line restarts icinga2, which is the final step to enable these
modules. Now, we need to update the configuration file for ido-pgsql to connect
it to our database that we manually set up above.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # vim /etc/icinga2/features-enabled/ido-pgsql.conf
</code></pre></div></div>

<p>Fill in the needed information as appropriate. Now you need to update the
<a href="http://php.net/manual/en/timezones.php">date.timezone</a> variable in the php configuration, which can be found
below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # vim /etc/php5/apache2/php.ini
</code></pre></div></div>

<p>As an example, mine is set to “<em>America/Detroit</em>”. Now, to allow the web server
to pass commands to icinga2, we need to modify the <strong>www-data</strong> user into the
proper group. On Debian, this is the nagios group.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # usermod -a -G nagios www-data
</code></pre></div></div>

<p>Finally, we need to use icingacli to generate our authentication token to run
initial setup.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # icingacli setup token create
captor tmp # icingacli setup token show
</code></pre></div></div>

<p>The second command will show you the token should you forget it. Now open a
browser and navigate to the localhost web page. and follow along.</p>

<p>Something to note is that you should never select skip verification until you
have checked all your log files in <code class="highlighter-rouge">/var/log</code>, and you are certain everything
is correct, and the programming is just being buggy. Also keep in mind that
postgres uses <strong>port 5432</strong>, not the default port of 3306. Finally, you should
set a password for the postgres’ database superuser, because you are
going to need to use the superuser’s account credentials in the setup program
to create the database.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>captor tmp # sudo -u postgres psql postgres

# \password postgres
Enter Password:
</code></pre></div></div>

<p>This will change the password, and with that, we can end this part. Next up
will be configuring hosts both capable of using the icinga2 protocol, and
configuring icinga to speak to simple hosts.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/08/10/Icinga2-Tutorial-Part-0/">
        Icinga2 Tutorial: Part 0 - Network Monitoring for the Masses
      </a>
    </h1>

    <span class="post-date">10 Aug 2015</span>

    <ul>
  <li><a href="/2015/08/11/Icinga2-Tutorial-Part-1/">Icinga2 Tutorial: Part 1 - Installation and Configuration</a></li>
  <li><a href="/2015/08/12/Icinga2-Tutorial-Part-2/">Icinga2 Tutorial: Part 2 - Agent-Less Checks</a></li>
  <li><a href="/2015/08/17/Icinga2-Tutorial-Part-3/">Icinga2 Tutorial: Part 3 - Agent-Based Checks</a></li>
  <li><a href="/2015/09/07/Icinga2-Tutorial-Part-4/">Icinga2 Tutorial: Part 4 - Expanding Checks to SNMP</a></li>
</ul>

<p><strong>EDIT (2018/12/09):</strong> <em>These guides haven’t been updated since 2015. It is
possible that there are dead links, or that the configuration syntax has changed
dramatically. These posts are also some of the most popular on my blog. I plan
to do a new guide eventually, but for right now please take the following
entries with a grain of salt.</em></p>

<h2 id="introduction">Introduction</h2>
<p>This will be a bit more informal than most of my posts as this is more of a
hobby project than anything with really standardized applications. I’ve been
exploring the network protocols available to me on my EdgeRouter now for the
past year, and last night I sat down and taught myself SNMP. After three
hours and poking around the MIBs, I realized that I absolutely hate SNMP.
That being said, I very much like the idea of it. I have to use a CLI and
a GUI on the same device most of the time to watch all the stats I like to
watch, and I immensely dislike putting that kind of rendering work on my
EdgeRouter, because I can assure you, the poor thing is taxed enough.</p>

<p>So I started exploring multi-protocol management systems today. Clearly,
Spiceworks is one of the best programs you can get. However, it is Windows
only. Here on Linux, I really only have NAGIOS, or so I thought.</p>

<h2 id="enter-icinga2">Enter Icinga2</h2>
<p>Icinga2 is a very interesting program to me in the same way that Maxthon
was a very interesting browser. Both Maxthon 2 and Icinga 1 were built on top
of existing applications (Internet Explorer and NAGIOS, respectively) with the
intent of expanding their functionality. I know a good many people who would
insist that NAGIOS has all the functionality you could ever need, and I would
agree, except for one thing. If I want ease of configuration, I have to pay
<a href="https://assets.nagios.com/handouts/nagiosxi/Nagios-XI-2014-Pricing-Documentation.pdf">$2000USD</a> for my small home network. I don’t have that kind of money, and
if I did, you can bet your ass it would go to getting me embedded development
boards or external controllers for debugging and programming. Anyways, then
Maxthon 3 came out, and it stepped away from the Trident engine, and went with
Google’s WebKit. Just like Maxthon, Icinga2 has stepped away from NAGIOS and has
become its own solution, but still remains compatibility with NAGIOS monitoring
plugins.</p>

<h2 id="purpose-of-these-posts">Purpose of These Posts</h2>
<p>At first this was just going to be something fun for me to do. However, I have
noticed a somewhat disturbing lack of end to end documentation for Icinga.
Yes, all the information is there in the <a href="http://docs.icinga.org/icinga2/latest/doc/module/icinga2/toc">manuals</a>, but it is still nice to
see how someone sets it up from end to end. This series of posts is going to
show how to do just that, starting with how to install Icinga, which will go up
in the next post.</p>

<h2 id="some-things-to-consider">Some Things to Consider</h2>
<p>This is my first time using Icinga2. You will be learning right along with me.
Which means some posts may spend a lot of time going back and working on things
that should have already been done. Besides that, I am not using an Icinga
dedicated machine, which means I am running a desktop release, Linux Mint
Debian Edition 2 to be exact. I like 2. It is a good number. Also the
distribution is really nice, and DOESN’T have systemd, but
that’s a post for another day.</p>

<p>Additionally, my deployment is rather small. All told I will be monitoring
about 10 devices at most across four or five protocols, a fairly standard home
network. I will keep adding updates the more I learn about it, or if I add more
services. However, you may need to do some extra research to tweak things for
your deployment.</p>

<p>I do plan to branch off into Netflow at some point. So you can expect
that in the future.</p>


  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    
      <a class="pagination-item newer" href="/page/3/">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
